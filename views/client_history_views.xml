<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <!-- Client Order History Tree View -->
    <record id="view_client_order_history_tree" model="ir.ui.view">
      <field name="name">client.order.history.tree</field>
      <field name="model">client.order.history</field>
      <field name="arch" type="xml">
        <tree string="Client Order History" sample="1">
          <field name="partner_id"/>
          <field name="order_year"/>
          <field name="box_type"/>
          <field name="experience_id"/>
          <field name="total_budget"/>
          <field name="total_products"/>
          <field name="budget_per_product"/>
          <field name="client_satisfaction"/>
          <field name="dietary_restrictions"/>
        </tree>
      </field>
    </record>

    <!-- Client Order History Form View -->
    <record id="view_client_order_history_form" model="ir.ui.view">
      <field name="name">client.order.history.form</field>
      <field name="model">client.order.history</field>
      <field name="arch" type="xml">
        <form string="Client Order History">
          <header>
            <button name="action_generate_next_composition"
                    string="ðŸ§  Generate Next Year"
                    type="object"
                    class="btn-primary"/>
          </header>
          <sheet>
            <div class="oe_title">
              <h1><field name="display_name" readonly="1"/></h1>
            </div>

            <group>
              <group string="Order Details">
                <field name="partner_id" readonly="1"/>
                <field name="order_year"/>
                <field name="box_type" widget="radio"/>
                <field name="total_budget"/>
                <field name="total_products"/>
                <field name="budget_per_product"/>
              </group>
              <group string="Performance">
                <field name="client_satisfaction" widget="radio"/>
                <field name="dietary_restrictions"/>
              </group>
            </group>

            <group string="Experience Details" attrs="{'invisible': [('box_type', '!=', 'experience')]}">
              <field name="experience_id" readonly="1"/>
            </group>

            <notebook>
              <page string="Products">
                <group string="Products in Box">
                  <field name="product_ids" nolabel="1" readonly="1">
                    <tree>
                      <field name="name"/>
                      <field name="lebiggot_category"/>
                      <field name="list_price"/>
                      <field name="product_grade"/>
                      <field name="brand"/>
                    </tree>
                  </field>
                </group>
              </page>

              <page string="Category Analysis">
                <group string="Category Breakdown (JSON)">
                  <field name="category_breakdown"/>
                </group>
              </page>

              <page string="Notes">
                <group string="Order Notes">
                  <field name="notes" nolabel="1"/>
                </group>
              </page>
            </notebook>
          </sheet>
        </form>
      </field>
    </record>

    <!-- Search View -->
    <record id="view_client_order_history_search" model="ir.ui.view">
      <field name="name">client.order.history.search</field>
      <field name="model">client.order.history</field>
      <field name="arch" type="xml">
        <search>
          <field name="partner_id"/>
          <field name="order_year"/>
          <field name="box_type"/>
          <field name="experience_id"/>

          <filter name="recent_years" string="Recent Years (2022+)" domain="[('order_year', '>=', 2022)]"/>
          <filter name="experience_boxes" string="Experience Boxes" domain="[('box_type', '=', 'experience')]"/>
          <filter name="custom_boxes" string="Custom Boxes" domain="[('box_type', '=', 'custom')]"/>
          <filter name="high_satisfaction" string="High Satisfaction (4-5â˜…)" domain="[('client_satisfaction', 'in', ['4','5'])]"/>

          <group expand="0" string="Group By">
            <filter name="group_by_client" string="Client" context="{'group_by': 'partner_id'}"/>
            <filter name="group_by_year" string="Year" context="{'group_by': 'order_year'}"/>
            <filter name="group_by_box_type" string="Box Type" context="{'group_by': 'box_type'}"/>
            <filter name="group_by_satisfaction" string="Satisfaction" context="{'group_by': 'client_satisfaction'}"/>
          </group>
        </search>
      </field>
    </record>

    <!-- Window Action -->
    <record id="action_client_order_history" model="ir.actions.act_window">
      <field name="name">Client Order History</field>
      <field name="res_model">client.order.history</field>
      <field name="view_mode">tree,form</field>
      <field name="help" type="html">
        <p class="o_view_nocontent_smiling_face">ðŸ“Š No client history yet!</p>
        <p>Add historical order data to help SeÃ±or Bigott learn client preferences and generate better recommendations.</p>
      </field>
    </record>

    <!-- Server Action (bound to Action menu on list/form) -->
    <record id="action_rebuild_client_history" model="ir.actions.server">
      <field name="name">Rebuild from Sales</field>
      <field name="model_id" ref="model_client_order_history"/>
      <field name="state">code</field>
      <field name="code">
        action = env['client.order.history'].rebuild_from_sales() or {'type': 'ir.actions.client', 'tag': 'reload'}
      </field>
      <field name="binding_model_id" ref="model_client_order_history"/>
      <field name="binding_type">action</field>
      <field name="binding_view_types">list,form</field>
    </record>

    <!-- Nightly cron to keep it fresh -->
    <record id="ir_cron_rebuild_client_history" model="ir.cron">
      <field name="name">Client History: Refresh from Sales</field>
      <field name="model_id" ref="model_client_order_history"/>
      <field name="state">code</field>
      <field name="code">model.rebuild_from_sales()</field>
      <field name="interval_number">1</field>
      <field name="interval_type">days</field>
      <field name="numbercall">-1</field>
      <field name="active">True</field>
    </record>

  </data>
</odoo>
