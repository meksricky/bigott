<?xml version="1.0" encoding="utf-8"?>
<!-- views/gift_composition_views.xml -->
<odoo>
    <data>
        
        <!-- Enhanced Form View -->
        <record id="view_gift_composition_form" model="ir.ui.view">
            <field name="name">gift.composition.form.enhanced</field>
            <field name="model">gift.composition</field>
            <field name="arch" type="xml">
                <form string="Gift Composition">
                    <header>
                        <button name="action_confirm" type="object" string="Confirm" 
                                states="draft" class="btn-primary"/>
                        <button name="action_deliver" type="object" string="Mark Delivered" 
                                states="confirmed" class="btn-success"/>
                        <button name="action_cancel" type="object" string="Cancel" 
                                states="draft,confirmed" class="btn-warning"/>
                        <button name="action_set_draft" type="object" string="Reset to Draft" 
                                states="cancelled" class="btn-secondary"/>
                        <button name="action_regenerate" type="object" string="🔄 Regenerate" 
                                states="draft" class="btn-info"/>
                        <button name="action_duplicate" type="object" string="📋 Duplicate" 
                                class="btn-secondary"/>
                        <button name="auto_categorize_products" type="object" 
                                string="🏷️ Auto-Categorize Products" 
                                states="draft" class="btn-secondary"/>
                        <field name="state" widget="statusbar" 
                               statusbar_visible="draft,confirmed,delivered"/>
                    </header>
                    
                    <sheet>
                        <!-- Composition Type Banner - Fixed syntax -->
                        <div class="oe_button_box" name="button_box">
                            <button class="oe_stat_button" icon="fa-gift">
                                <field name="composition_type" widget="statinfo" string="Type"/>
                            </button>
                            <button class="oe_stat_button" icon="fa-cubes">
                                <field name="product_count" widget="statinfo" string="Products"/>
                            </button>
                            <button class="oe_stat_button" icon="fa-euro">
                                <field name="budget_variance" widget="statinfo" string="Variance %"/>
                            </button>
                        </div>
                        
                        <div class="oe_title">
                            <h1>
                                <field name="display_name" readonly="1"/>
                            </h1>
                            <h3 attrs="{'invisible': [('experience_name', '=', False)]}">
                                <field name="experience_name" readonly="1"/>
                            </h3>
                        </div>
                        
                        <group col="4">
                            <field name="name" readonly="1"/>
                            <field name="partner_id" options="{'no_create': True}"/>
                            <field name="currency_id" invisible="1"/>
                            <field name="target_budget" widget="monetary"/>
                            <field name="actual_cost" widget="monetary" readonly="1"/>
                            <field name="target_year"/>
                            <field name="composition_type"/>
                            <field name="experience_code" 
                                   attrs="{'invisible': [('composition_type', 'not in', ['experience', 'hybrid'])]}"/>
                            <field name="experience_category" 
                                   attrs="{'invisible': [('composition_type', 'not in', ['experience', 'hybrid'])]}"/>
                        </group>
                        
                        <group string="Dietary &amp; Notes" col="2">
                            <group>
                                <field name="dietary_restriction_type"/>
                                <field name="dietary_restrictions" 
                                       attrs="{'invisible': [('dietary_restriction_type', '!=', 'multiple')]}"/>
                            </group>
                            <group>
                                <field name="client_notes"/>
                                <field name="internal_notes"/>
                            </group>
                        </group>
                        
                        <notebook>
                            <!-- Products by Category -->
                            <page string="🍷 Beverages" attrs="{'invisible': [('composition_type', '=', 'experience')]}">
                                <field name="beverage_product_ids">
                                    <tree string="Beverage Products" create="false" delete="false">
                                        <field name="name"/>
                                        <field name="default_code"/>
                                        <field name="list_price" widget="monetary"/>
                                    </tree>
                                </field>
                            </page>
                            
                            <page string="🥃 Aperitifs" attrs="{'invisible': [('composition_type', '=', 'experience')]}">
                                <field name="aperitif_product_ids">
                                    <tree string="Aperitif Products" create="false" delete="false">
                                        <field name="name"/>
                                        <field name="default_code"/>
                                        <field name="list_price" widget="monetary"/>
                                    </tree>
                                </field>
                            </page>
                            
                            <page string="🦆 Foie Gras" attrs="{'invisible': [('composition_type', '=', 'experience')]}">
                                <field name="foie_product_ids">
                                    <tree string="Foie Gras Products" create="false" delete="false">
                                        <field name="name"/>
                                        <field name="default_code"/>
                                        <field name="list_price" widget="monetary"/>
                                    </tree>
                                </field>
                            </page>
                            
                            <page string="🥫 Canned Foods" attrs="{'invisible': [('composition_type', '=', 'experience')]}">
                                <field name="canned_product_ids">
                                    <tree string="Canned Products" create="false" delete="false">
                                        <field name="name"/>
                                        <field name="default_code"/>
                                        <field name="list_price" widget="monetary"/>
                                    </tree>
                                </field>
                            </page>
                            
                            <page string="🥓 Charcuterie" attrs="{'invisible': [('composition_type', '=', 'experience')]}">
                                <field name="charcuterie_product_ids">
                                    <tree string="Charcuterie Products" create="false" delete="false">
                                        <field name="name"/>
                                        <field name="default_code"/>
                                        <field name="list_price" widget="monetary"/>
                                    </tree>
                                </field>
                            </page>
                            
                            <page string="🍬 Sweets" attrs="{'invisible': [('composition_type', '=', 'experience')]}">
                                <field name="sweet_product_ids">
                                    <tree string="Sweet Products" create="false" delete="false">
                                        <field name="name"/>
                                        <field name="default_code"/>
                                        <field name="list_price" widget="monetary"/>
                                    </tree>
                                </field>
                            </page>
                            
                            <!-- All Products (always visible) -->
                            <page string="📦 All Products">
                                <field name="product_ids">
                                    <tree string="All Products" create="false" delete="false">
                                        <field name="name"/>
                                        <field name="default_code"/>
                                        <field name="categ_id"/>
                                        <field name="list_price" widget="monetary"/>
                                        <field name="qty_available"/>
                                    </tree>
                                </field>
                                <group class="oe_subtotal_footer">
                                    <field name="actual_cost" widget="monetary" class="oe_subtotal_footer_separator"/>
                                </group>
                            </page>
                            
                            <!-- AI Information -->
                            <page string="🤖 AI Details" groups="base.group_system">
                                <group col="2">
                                    <field name="generation_method"/>
                                    <field name="confidence_score" widget="percentage"/>
                                    <field name="ai_reasoning" widget="text"/>
                                    <field name="category_distribution" readonly="1"/>
                                </group>
                            </page>
                        </notebook>
                        
                    </sheet>
                    
                    <!-- Chatter widget - now works because we inherit mail.thread -->
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids" widget="mail_activity"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>
        
        <!-- Enhanced Tree View -->
        <record id="view_gift_composition_tree" model="ir.ui.view">
            <field name="name">gift.composition.tree.enhanced</field>
            <field name="model">gift.composition</field>
            <field name="arch" type="xml">
                <tree string="Gift Compositions" 
                      decoration-success="state=='delivered'" 
                      decoration-warning="state=='confirmed'" 
                      decoration-danger="state=='cancelled'">
                    <field name="display_name"/>
                    <field name="partner_id"/>
                    <field name="composition_type"/>
                    <field name="experience_name"/>
                    <field name="target_budget" widget="monetary"/>
                    <field name="actual_cost" widget="monetary"/>
                    <field name="budget_variance" widget="percentage"/>
                    <field name="product_count"/>
                    <field name="dietary_restriction_type"/>
                    <field name="state" widget="badge" 
                           decoration-success="state=='delivered'"
                           decoration-warning="state=='confirmed'"
                           decoration-danger="state=='cancelled'"
                           decoration-info="state=='draft'"/>
                </tree>
            </field>
        </record>
        
        <!-- Search View -->
        <record id="view_gift_composition_search" model="ir.ui.view">
            <field name="name">gift.composition.search</field>
            <field name="model">gift.composition</field>
            <field name="arch" type="xml">
                <search string="Search Compositions">
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="experience_name"/>
                    
                    <filter string="Experience" name="filter_experience" 
                            domain="[('composition_type', '=', 'experience')]"/>
                    <filter string="Custom Made" name="filter_custom" 
                            domain="[('composition_type', '=', 'custom')]"/>
                    <filter string="Hybrid" name="filter_hybrid" 
                            domain="[('composition_type', '=', 'hybrid')]"/>
                    
                    <separator/>
                    
                    <filter string="Halal" name="filter_halal" 
                            domain="[('dietary_restriction_type', '=', 'halal')]"/>
                    <filter string="Vegan" name="filter_vegan" 
                            domain="[('dietary_restriction_type', '=', 'vegan')]"/>
                    <filter string="Vegetarian" name="filter_vegetarian" 
                            domain="[('dietary_restriction_type', '=', 'vegetarian')]"/>
                    
                    <separator/>
                    
                    <filter string="Draft" name="filter_draft" 
                            domain="[('state', '=', 'draft')]"/>
                    <filter string="Confirmed" name="filter_confirmed" 
                            domain="[('state', '=', 'confirmed')]"/>
                    <filter string="Delivered" name="filter_delivered" 
                            domain="[('state', '=', 'delivered')]"/>
                    
                    <group expand="0" string="Group By">
                        <filter string="Client" name="group_partner" 
                                context="{'group_by': 'partner_id'}"/>
                        <filter string="Type" name="group_type" 
                                context="{'group_by': 'composition_type'}"/>
                        <filter string="State" name="group_state" 
                                context="{'group_by': 'state'}"/>
                        <filter string="Year" name="group_year" 
                                context="{'group_by': 'target_year'}"/>
                        <filter string="Dietary" name="group_dietary" 
                                context="{'group_by': 'dietary_restriction_type'}"/>
                    </group>
                </search>
            </field>
        </record>
        
        <!-- Action -->
        <record id="action_gift_composition" model="ir.actions.act_window">
            <field name="name">Gift Compositions</field>
            <field name="res_model">gift.composition</field>
            <field name="view_mode">tree,form,pivot,graph</field>
            <field name="search_view_id" ref="view_gift_composition_search"/>
            <field name="context">{'search_default_filter_draft': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first gift composition
                </p>
                <p>
                    Gift compositions can be Experience-based or Custom Made.
                    Use the wizard to generate AI-powered recommendations.
                </p>
            </field>
        </record>
        
    </data>
</odoo>