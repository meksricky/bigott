<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- Enhanced Form View -->
        <record id="view_gift_composition_form" model="ir.ui.view">
            <field name="name">gift.composition.form</field>
            <field name="model">gift.composition</field>
            <field name="arch" type="xml">
                <form string="Gift Composition">
                    <header>
                        <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,delivered"/>
                        <button name="action_confirm" string="Confirm" type="object" class="btn-primary" attrs="{'invisible': [('state', '!=', 'draft')]}"/>
                        <button name="action_cancel" string="Cancel" type="object" attrs="{'invisible': [('state', 'not in', ['draft', 'confirmed'])]}"/>
                        <button name="action_regenerate" string="🔄 Regenerate" type="object" class="btn-warning" attrs="{'invisible': [('state', '!=', 'draft')]}"/>
                    </header>
                    
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_duplicate" string="Duplicate" type="object" class="oe_stat_button" icon="fa-copy"/>
                            <button name="auto_categorize_products" string="Auto-Categorize Products" type="object" class="oe_stat_button" icon="fa-tags"/>
                        </div>
                        
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="1"/>
                            </h1>
                            <h2>
                                <field name="partner_id"/>
                            </h2>
                        </div>
                        
                        <group>
                            <group string="Composition Details">
                                <field name="reference"/>
                                <field name="composition_type"/>
                                <field name="target_budget"/>
                                <field name="actual_cost" readonly="1"/>
                                <field name="variance_percentage" widget="progressbar"/>
                                <field name="target_year"/>
                            </group>
                            <group string="Generation Info">
                                <field name="generation_method"/>
                                <field name="confidence_score" widget="progressbar" attrs="{'invisible': [('generation_method', '!=', 'ollama')]}"/>
                                <field name="experience_code" attrs="{'invisible': [('composition_type', '!=', 'experience')]}"/>
                                <field name="product_count" readonly="1"/>
                                <field name="state"/>
                            </group>
                        </group>
                        
                        <group string="Dietary &amp; Notes">
                            <group>
                                <field name="dietary_restrictions" placeholder="e.g., Halal, Vegan, Gluten-free"/>
                            </group>
                            <group>
                                <field name="client_notes" placeholder="Special requirements from client"/>
                                <field name="internal_notes" placeholder="Internal notes (not visible to client)"/>
                            </group>
                        </group>
                        
                        <!-- NOTEBOOK WITH ALL TABS -->
                        <notebook>
                            <!-- Enhanced Products Tab with Category Sub-tabs -->
                            <page string="📦 Products" name="products">
                                <notebook>
                                    <!-- Beverages Tab -->
                                    <page string="🍷 Beverages" name="beverages_tab">
                                        <field name="beverage_product_ids">
                                            <tree editable="bottom">
                                                <field name="name"/>
                                                <field name="default_code"/>
                                                <field name="list_price"/>
                                            </tree>
                                        </field>
                                    </page>
                                    
                                    <!-- Aperitifs Tab -->
                                    <page string="🥃 Aperitifs" name="aperitifs_tab">
                                        <field name="aperitif_product_ids">
                                            <tree editable="bottom">
                                                <field name="name"/>
                                                <field name="default_code"/>
                                                <field name="list_price"/>
                                            </tree>
                                        </field>
                                    </page>
                                    
                                    <!-- Foie Gras Tab -->
                                    <page string="🦆 Foie Gras" name="foie_tab">
                                        <field name="foie_product_ids">
                                            <tree editable="bottom">
                                                <field name="name"/>
                                                <field name="default_code"/>
                                                <field name="list_price"/>
                                            </tree>
                                        </field>
                                    </page>
                                    
                                    <!-- Canned Foods Tab -->
                                    <page string="🥫 Canned Foods" name="canned_tab">
                                        <field name="canned_product_ids">
                                            <tree editable="bottom">
                                                <field name="name"/>
                                                <field name="default_code"/>
                                                <field name="list_price"/>
                                            </tree>
                                        </field>
                                    </page>
                                    
                                    <!-- Charcuterie Tab -->
                                    <page string="🥓 Charcuterie" name="charcuterie_tab">
                                        <field name="charcuterie_product_ids">
                                            <tree editable="bottom">
                                                <field name="name"/>
                                                <field name="default_code"/>
                                                <field name="list_price"/>
                                            </tree>
                                        </field>
                                    </page>
                                    
                                    <!-- Sweets Tab -->
                                    <page string="🍬 Sweets" name="sweets_tab">
                                        <field name="sweet_product_ids">
                                            <tree editable="bottom">
                                                <field name="name"/>
                                                <field name="default_code"/>
                                                <field name="list_price"/>
                                            </tree>
                                        </field>
                                    </page>
                                    
                                    <!-- All Products Tab -->
                                    <page string="📋 All Products" name="all_products_tab">
                                        <field name="product_ids">
                                            <tree editable="bottom">
                                                <field name="name"/>
                                                <field name="default_code"/>
                                                <field name="categ_id"/>
                                                <field name="list_price"/>
                                            </tree>
                                        </field>
                                    </page>
                                </notebook>
                                
                                <!-- Budget Summary Footer -->
                                <group class="oe_subtotal_footer oe_right">
                                    <field name="actual_cost" widget="monetary" class="oe_subtotal_footer_separator"/>
                                    <field name="target_budget" widget="monetary"/>
                                    <field name="variance_amount" widget="monetary"/>
                                </group>
                            </page>
                            
                            <!-- Categories Tab -->
                            <page string="📊 Categories" name="categories">
                                <group string="Category Distribution">
                                    <field name="categories_distribution" widget="html" readonly="1" nolabel="1"/>
                                </group>
                                <group col="4" string="Category Counts">
                                    <field name="total_categories" readonly="1"/>
                                    <field name="wine_count" readonly="1"/>
                                    <field name="cheese_count" readonly="1"/>
                                    <field name="gourmet_count" readonly="1"/>
                                </group>
                            </page>
                            
                            <!-- AI Insights Tab -->
                            <page string="🤖 AI Insights" name="ai_insights" attrs="{'invisible': [('generation_method', '!=', 'ollama')]}">
                                <group string="Generation Details">
                                    <field name="ai_reasoning" readonly="1" widget="text" nolabel="1"/>
                                </group>
                                <group col="4" string="AI Metrics">
                                    <field name="confidence_score" widget="percentage"/>
                                    <field name="generation_method"/>
                                    <field name="compliance_status" attrs="{'invisible': [('compliance_status', '=', False)]}"/>
                                    <field name="generation_strategy" attrs="{'invisible': [('generation_strategy', '=', False)]}"/>
                                </group>
                            </page>
                            
                            <!-- Statistics Tab -->
                            <page string="📈 Statistics" name="statistics">
                                <group col="4">
                                    <field name="product_count"/>
                                    <field name="total_categories"/>
                                    <field name="actual_cost"/>
                                    <field name="target_budget"/>
                                    <field name="variance_percentage" widget="percentage"/>
                                    <field name="variance_amount"/>
                                </group>
                                <group string="Price Analysis">
                                    <field name="avg_product_price" readonly="1"/>
                                    <field name="min_product_price" readonly="1"/>
                                    <field name="max_product_price" readonly="1"/>
                                    <field name="price_std_deviation" readonly="1"/>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    
                    <!-- Chatter -->
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>
        
        <!-- Enhanced Tree View -->
        <record id="view_gift_composition_tree" model="ir.ui.view">
            <field name="name">gift.composition.tree.enhanced</field>
            <field name="model">gift.composition</field>
            <field name="arch" type="xml">
                <tree string="Gift Compositions" 
                      decoration-success="state=='delivered'" 
                      decoration-warning="state=='confirmed'" 
                      decoration-danger="state=='cancelled'">
                    <field name="display_name"/>
                    <field name="partner_id"/>
                    <field name="composition_type"/>
                    <field name="experience_name"/>
                    <field name="target_budget" widget="monetary"/>
                    <field name="actual_cost" widget="monetary"/>
                    <field name="budget_variance" widget="percentage"/>
                    <field name="product_count"/>
                    <field name="dietary_restriction_type"/>
                    <field name="state" widget="badge" 
                           decoration-success="state=='delivered'"
                           decoration-warning="state=='confirmed'"
                           decoration-danger="state=='cancelled'"
                           decoration-info="state=='draft'"/>
                </tree>
            </field>
        </record>
        
        <!-- Search View -->
        <record id="view_gift_composition_search" model="ir.ui.view">
            <field name="name">gift.composition.search</field>
            <field name="model">gift.composition</field>
            <field name="arch" type="xml">
                <search string="Search Compositions">
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="experience_name"/>
                    
                    <filter string="Experience" name="filter_experience" 
                            domain="[('composition_type', '=', 'experience')]"/>
                    <filter string="Custom Made" name="filter_custom" 
                            domain="[('composition_type', '=', 'custom')]"/>
                    <filter string="Hybrid" name="filter_hybrid" 
                            domain="[('composition_type', '=', 'hybrid')]"/>
                    
                    <separator/>
                    
                    <filter string="Halal" name="filter_halal" 
                            domain="[('dietary_restriction_type', '=', 'halal')]"/>
                    <filter string="Vegan" name="filter_vegan" 
                            domain="[('dietary_restriction_type', '=', 'vegan')]"/>
                    <filter string="Vegetarian" name="filter_vegetarian" 
                            domain="[('dietary_restriction_type', '=', 'vegetarian')]"/>
                    
                    <separator/>
                    
                    <filter string="Draft" name="filter_draft" 
                            domain="[('state', '=', 'draft')]"/>
                    <filter string="Confirmed" name="filter_confirmed" 
                            domain="[('state', '=', 'confirmed')]"/>
                    <filter string="Delivered" name="filter_delivered" 
                            domain="[('state', '=', 'delivered')]"/>
                    
                    <group expand="0" string="Group By">
                        <filter string="Client" name="group_partner" 
                                context="{'group_by': 'partner_id'}"/>
                        <filter string="Type" name="group_type" 
                                context="{'group_by': 'composition_type'}"/>
                        <filter string="State" name="group_state" 
                                context="{'group_by': 'state'}"/>
                        <filter string="Year" name="group_year" 
                                context="{'group_by': 'target_year'}"/>
                        <filter string="Dietary" name="group_dietary" 
                                context="{'group_by': 'dietary_restriction_type'}"/>
                    </group>
                </search>
            </field>
        </record>
        
        <!-- Action -->
        <record id="action_gift_composition" model="ir.actions.act_window">
            <field name="name">Gift Compositions</field>
            <field name="res_model">gift.composition</field>
            <field name="view_mode">tree,form,pivot,graph</field>
            <field name="search_view_id" ref="view_gift_composition_search"/>
            <field name="context">{'search_default_filter_draft': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first gift composition
                </p>
                <p>
                    Gift compositions can be Experience-based or Custom Made.
                    Use the wizard to generate AI-powered recommendations.
                </p>
            </field>
        </record>
        
    </data>
</odoo>