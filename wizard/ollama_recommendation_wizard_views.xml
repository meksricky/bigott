<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- Ollama Recommendation Wizard Form View -->
        <record id="view_ollama_recommendation_wizard_form" model="ir.ui.view">
            <field name="name">ollama.recommendation.wizard.form</field>
            <field name="model">ollama.recommendation.wizard</field>
            <field name="arch" type="xml">
                <form string="üéÅ AI Gift Composition Generator">
                    <header>
                        <field name="state" widget="statusbar" statusbar_visible="draft,generating,done"/>
                    </header>
                    <sheet>
                        <!-- Title Section -->
                        <div class="oe_title">
                            <h1 style="color: #875A7B;">
                                <i class="fa fa-robot"/> AI Gift Recommendation Wizard
                            </h1>
                            <field name="ollama_status" nolabel="1"/>
                        </div>
                        
                        <!-- Main Content in Tabs -->
                        <notebook>
                            <!-- Tab 1: Client & Budget -->
                            <page string="Client &amp; Budget" name="client_budget">
                                <group>
                                    <group name="client_section" string="Client Selection">
                                        <field name="partner_id" 
                                               options="{'no_create': True}"
                                               placeholder="Select client..."/>
                                        <field name="expected_strategy" 
                                               attrs="{'invisible': [('partner_id', '=', False)]}"
                                               readonly="1"/>
                                    </group>
                                    <group name="budget_section" string="Budget Configuration">
                                        <field name="target_budget" widget="monetary"/>
                                        <field name="currency_id" invisible="1"/>
                                        <field name="target_year"/>
                                        <label for="business_rules_applicable" string="Business Rules"/>
                                        <div>
                                            <field name="business_rules_applicable" 
                                                   readonly="1"
                                                   attrs="{'invisible': [('partner_id', '=', False)]}"
                                                   widget="boolean_button"
                                                   options="{'terminology': {
                                                       'string_true': 'Applicable',
                                                       'string_false': 'Not Applicable',
                                                       'hover_true': 'Business rules will be applied',
                                                       'hover_false': 'No rules to apply'
                                                   }}"/>
                                        </div>
                                    </group>
                                </group>
                                
                                <!-- Dynamic Client Information -->
                                <separator string="Client Analysis" attrs="{'invisible': [('partner_id', '=', False)]}"/>
                                <div attrs="{'invisible': [('partner_id', '=', False)]}">
                                    <field name="client_info" nolabel="1" readonly="1"/>
                                </div>
                                
                                <!-- AI Recommendations Panel -->
                                <separator string="AI Recommendations" attrs="{'invisible': [('partner_id', '=', False)]}"/>
                                <group attrs="{'invisible': [('partner_id', '=', False)]}" col="3">
                                    <group>
                                        <field name="budget_recommendation" readonly="1" nolabel="1"/>
                                    </group>
                                    <group>
                                        <field name="approach_recommendation" readonly="1" nolabel="1"/>
                                    </group>
                                    <group>
                                        <field name="risk_level" widget="badge" readonly="1" nolabel="1"
                                               decoration-success="risk_level == 'low'"
                                               decoration-warning="risk_level == 'medium'"
                                               decoration-danger="risk_level == 'high'"/>
                                    </group>
                                </group>
                                
                                <!-- Hidden fields for computations -->
                                <group invisible="1">
                                    <field name="has_previous_orders"/>
                                    <field name="has_last_year_data"/>
                                </group>
                            </page>
                            
                            <!-- Tab 2: Composition Settings -->
                            <page string="Composition" name="composition_settings">
                                <group>
                                    <group string="Composition Type">
                                        <field name="force_composition_type" widget="radio" options="{'horizontal': false}"/>
                                        <!-- Hidden fields to sync -->
                                        <field name="composition_type" invisible="1"/>
                                        <field name="engine_type" invisible="1"/>
                                    </group>
                                    <group string="Product Configuration">
                                        <field name="specify_product_count"/>
                                        <field name="product_count" 
                                               placeholder="Number of products..."
                                               attrs="{'invisible': [('specify_product_count', '=', False)],
                                                      'required': [('specify_product_count', '=', True)]}"/>
                                    </group>
                                </group>
                                
                                <!-- Experience Selection (fixed) -->
                                <separator string="Experience Selection" 
                                          attrs="{'invisible': [('force_composition_type', '!=', 'experience')]}"/>
                                <group attrs="{'invisible': [('force_composition_type', '!=', 'experience')]}">
                                    <group>
                                        <field name="experience_category_filter" 
                                               string="Filter by Category"/>
                                        <field name="selected_experience" 
                                               string="Select Experience"
                                               options="{'no_create': True}"/>
                                    </group>
                                    <group>
                                        <!-- Experience preview -->
                                        <div attrs="{'invisible': [('selected_experience', '=', False)]}">
                                            <field name="experience_preview" nolabel="1"/>
                                        </div>
                                    </group>
                                </group>
                            </page>
                            
                            <!-- Tab 3: Dietary & Preferences (Simplified) -->
                            <page string="Dietary &amp; Preferences" name="dietary_prefs">
                                <group>
                                    <group string="Quick Selection">
                                        <field name="dietary_restrictions" widget="radio" options="{'horizontal': false}"/>
                                        <field name="dietary_restrictions_text" 
                                               placeholder="Enter additional restrictions (comma-separated)..."
                                               attrs="{'invisible': [('dietary_restrictions', '!=', 'multiple')]}"/>
                                    </group>
                                    <group string="Detailed Selection" groups="base.group_no_one">
                                        <field name="is_halal" widget="boolean_toggle"/>
                                        <field name="is_vegan" widget="boolean_toggle"/>
                                        <field name="is_vegetarian" widget="boolean_toggle"/>
                                        <field name="is_gluten_free" widget="boolean_toggle"/>
                                        <field name="is_non_alcoholic" widget="boolean_toggle"/>
                                    </group>
                                </group>
                                
                                <!-- Client Dietary History -->
                                <separator string="Client History" attrs="{'invisible': [('partner_id', '=', False)]}"/>
                                <group attrs="{'invisible': [('partner_id', '=', False)]}" col="1">
                                    <field name="partner_dietary_restrictions" readonly="1" nolabel="1"/>
                                    <field name="client_dietary_history" readonly="1" nolabel="1"/>
                                </group>
                            </page>
                            
                            <!-- Tab 4: Notes & Instructions -->
                            <page string="Notes &amp; Instructions" name="notes">
                                <group col="1">
                                    <field name="client_notes" 
                                           nolabel="1"
                                           widget="text"
                                           placeholder="Enter any special requirements, preferences, or instructions...&#10;&#10;Examples:&#10;‚Ä¢ 'Client loves Spanish wines and artisanal cheeses'&#10;‚Ä¢ 'Budget flexible up to ‚Ç¨1500 for exceptional items'&#10;‚Ä¢ 'Include exactly 15 products'&#10;‚Ä¢ 'No chocolates or nuts (allergy)'&#10;‚Ä¢ 'Prefers traditional products over modern'"
                                           style="min-height: 200px; width: 100%;"/>
                                </group>
                                <div class="alert alert-info" role="alert" style="margin-top: 16px;">
                                    <h4 class="alert-heading">
                                        <i class="fa fa-info-circle"/> Note:
                                    </h4>
                                    <p>Information in this field takes precedence over other settings. The AI will intelligently parse your notes to extract budget, product count, and preferences.</p>
                                </div>
                            </page>
                            
                            <!-- Tab 5: History Analysis -->
                            <page string="History Analysis" name="history" 
                                  attrs="{'invisible': [('partner_id', '=', False)]}">
                                <field name="client_history_summary" nolabel="1" readonly="1"/>
                                
                                <!-- Similar Clients Analysis -->
                                <separator string="Similar Clients Analysis" 
                                          attrs="{'invisible': [('has_previous_orders', '=', True)]}"/>
                                <div attrs="{'invisible': [('has_previous_orders', '=', True)]}" 
                                     class="alert alert-info">
                                    <p><b>New Client Strategy:</b></p>
                                    <ul>
                                        <li>AI will analyze similar clients in your database</li>
                                        <li>Patterns from clients with similar characteristics will be used</li>
                                        <li>Industry best practices will be applied</li>
                                        <li>Consider adding detailed notes for better personalization</li>
                                    </ul>
                                </div>
                            </page>
                            
                            <!-- Tab 6: Results (shown after generation) -->
                            <page string="Results" name="results" 
                                  attrs="{'invisible': [('state', 'not in', ['done', 'error'])]}">
                                <group attrs="{'invisible': [('state', '!=', 'done')]}" col="4">
                                    <field name="composition_id" readonly="1" colspan="2"/>
                                    <field name="confidence_score" widget="percentage" readonly="1"/>
                                    <newline/>
                                    <field name="total_cost" widget="monetary" readonly="1"/>
                                    <field name="product_count_actual" readonly="1" string="Products Generated"/>
                                </group>
                                
                                <separator string="Generation Details"/>
                                <field name="result_message" 
                                       nolabel="1" 
                                       readonly="1"
                                       attrs="{'invisible': [('state', '!=', 'done')]}"/>
                                       
                                <field name="error_message" 
                                       nolabel="1" 
                                       readonly="1"
                                       widget="text"
                                       attrs="{'invisible': [('state', '!=', 'error')]}"
                                       style="color: red;"/>
                                
                                <separator string="Generated Products" 
                                          attrs="{'invisible': [('recommended_products', '=', [])]}"/>
                                <field name="recommended_products" 
                                       readonly="1"
                                       attrs="{'invisible': [('recommended_products', '=', [])]}"
                                       context="{'tree_view_ref': 'product.product_template_tree_view'}">
                                    <tree>
                                        <field name="default_code" optional="show"/>
                                        <field name="name"/>
                                        <field name="categ_id" optional="show"/>
                                        <field name="list_price" widget="monetary" sum="Total"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    
                    <!-- Footer Buttons -->
                    <footer>
                        <!-- Main action buttons -->
                        <button name="action_generate_recommendation" 
                                string="üöÄ Generate Composition" 
                                type="object" 
                                class="btn-primary"
                                attrs="{'invisible': ['|', ('state', '!=', 'draft'), ('partner_id', '=', False)]}"
                                confirm="Generate AI composition for this client?"
                                data-hotkey="g"/>
                        
                        <button name="action_view_composition" 
                                string="üìÑ View Composition" 
                                type="object" 
                                class="btn-success"
                                attrs="{'invisible': [('composition_id', '=', False)]}"
                                data-hotkey="v"/>
                        
                        <button name="action_generate_another" 
                                string="üîÑ Generate Another" 
                                type="object" 
                                class="btn-warning"
                                attrs="{'invisible': [('state', '!=', 'done')]}"/>
                        
                        <!-- Utility buttons -->
                        <button name="action_test_connection" 
                                string="üîå Test Ollama" 
                                type="object" 
                                class="btn-sm btn-info"
                                attrs="{'invisible': [('state', 'not in', ['draft', 'error'])]}"/>
                        
                        <button string="Close" 
                                class="btn-secondary" 
                                special="cancel"
                                data-hotkey="x"/>
                        
                        <!-- State indicator -->
                        <div class="text-muted float-left" 
                             attrs="{'invisible': [('partner_id', '!=', False)]}"
                             style="margin-left: 16px;">
                            <i class="fa fa-arrow-up"/> Select a client to begin
                        </div>
                    </footer>
                </form>
            </field>
        </record>
        
        <!-- Ollama Recommendation Wizard Action -->
        <record id="action_ollama_recommendation_wizard" model="ir.actions.act_window">
            <field name="name">üéÅ AI Gift Recommendation</field>
            <field name="res_model">ollama.recommendation.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="context">{'default_target_budget': 1000.0}</field>
        </record>
        
        <!-- Add Menu Item (optional) -->
        <menuitem id="menu_ollama_recommendation_wizard"
                  name="AI Gift Recommendations"
                  parent="sale.sale_menu_root"
                  action="action_ollama_recommendation_wizard"
                  sequence="50"
                  groups="sales_team.group_sale_salesman"/>
        
    </data>
</odoo>